#!/usr/bin/env bash
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m' # No Color

pass() { echo -e "  ${GREEN}✓${NC} $1"; }
warn() { echo -e "  ${YELLOW}!${NC} $1"; }
fail() { echo -e "  ${RED}✗${NC} $1"; }

echo ""
echo -e "${BOLD}claude-on-rails-demo quickstart${NC}"
echo "================================"
echo ""

errors=0

# --- Check Ruby ---
echo -e "${BOLD}Checking prerequisites...${NC}"
echo ""

if command -v ruby &> /dev/null; then
  ruby_version=$(ruby -v | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
  if [ "$ruby_version" = "3.4.5" ]; then
    pass "Ruby $ruby_version"
  else
    warn "Ruby $ruby_version found (expected 3.4.5 -- may work, but not guaranteed)"
  fi
else
  fail "Ruby not found. Install it: brew install rbenv ruby-build && rbenv install 3.4.5"
  errors=$((errors + 1))
fi

# --- Check Bundler ---
if command -v bundle &> /dev/null; then
  pass "Bundler $(bundle -v | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)"
else
  fail "Bundler not found. Install it: gem install bundler"
  errors=$((errors + 1))
fi

# --- Check SQLite3 ---
if command -v sqlite3 &> /dev/null; then
  pass "SQLite3 $(sqlite3 --version | awk '{print $1}')"
else
  fail "SQLite3 not found. Install it: brew install sqlite3"
  errors=$((errors + 1))
fi

# --- Check Claude CLI (warn only) ---
if command -v claude &> /dev/null; then
  pass "Claude CLI"
else
  warn "Claude CLI not found -- the Rails app works without it, but you need it to run the agent swarm"
  warn "Install: https://docs.anthropic.com/en/docs/claude-code/overview"
fi

# --- Check claude-swarm (warn only) ---
if command -v claude-swarm &> /dev/null; then
  pass "claude-swarm"
else
  warn "claude-swarm not found -- install it with: gem install claude-swarm"
fi

echo ""

# --- Bail if hard requirements are missing ---
if [ $errors -gt 0 ]; then
  echo -e "${RED}${BOLD}Missing required tools. Fix the errors above and re-run bin/quickstart.${NC}"
  echo ""
  exit 1
fi

# --- Install gems ---
echo -e "${BOLD}Installing dependencies...${NC}"
echo ""
bundle install
echo ""

# --- Prepare database ---
echo -e "${BOLD}Preparing database...${NC}"
echo ""
bin/rails db:prepare
echo ""

# --- Done ---
echo -e "${GREEN}${BOLD}Setup complete!${NC}"
echo ""
echo "Next steps:"
echo ""
echo "  1. Start the Rails server:"
echo "     bin/rails server"
echo ""
echo "  2. Open your browser:"
echo "     http://localhost:3000"
echo ""
echo "  3. In a second terminal, launch the agent swarm:"
echo "     claude-swarm"
echo ""
echo "  4. Tell the swarm what to build:"
echo '     > Add a Contact page with a name field and email field'
echo ""
